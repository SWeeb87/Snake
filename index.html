<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <title>Unity Web Player | Snake</title>
    <link rel="shortcut icon" href="TemplateData/favicon.ico">
    <link rel="stylesheet" href="TemplateData/style.css">
  </head>
  <body>
    <div id="unity-container" class="unity-desktop">
      <canvas id="unity-canvas" width=960 height=600 tabindex="-1"></canvas>
      <div id="unity-loading-bar">
        <div id="unity-logo"></div>
        <div id="unity-progress-bar-empty">
          <div id="unity-progress-bar-full"></div>
        </div>
      </div>
      <div id="unity-warning"> </div>
      <div id="unity-footer">
        <div id="unity-logo-title-footer"></div>
        <div id="unity-fullscreen-button"></div>
        <div id="unity-build-title">Snake</div>
      </div>
    </div>
    <script>
      async function fetchWasmParts(baseUrl, numParts) {
        const parts = [];
        for (let i = 0; i < numParts; i++) {
          const response = await fetch(`${baseUrl}/Snake Build.wasm.part${i}`);
          if (!response.ok) {
            throw new Error(`Errore nel caricamento della parte ${i}: ${response.statusText}`);
          }
          const buffer = await response.arrayBuffer();
          parts.push(buffer);
        }
        return new Uint8Array(parts.reduce((acc, part) => {
          acc.push(...Array.from(new Uint8Array(part)));
          return acc;
        }, []));
      }

      async function loadWasm() {
        try {
          const wasmParts = await fetchWasmParts('Build', 2); // Modifica 3 con il numero effettivo di parti
          const wasmBlob = new Blob([wasmParts], { type: 'application/wasm' });
          const wasmUrl = URL.createObjectURL(wasmBlob);

          var canvas = document.querySelector("#unity-canvas");
          var buildUrl = "Build";
          var loaderUrl = buildUrl + "/Snake Build.loader.js";
          var config = {
            arguments: [],
            dataUrl: buildUrl + "/Snake Build.data.gz",
            frameworkUrl: buildUrl + "/Snake Build.framework.js.gz",
            codeUrl: wasmUrl,
            streamingAssetsUrl: "StreamingAssets",
            companyName: "SWeeb",
            productName: "Snake",
            productVersion: "1.0",
            showBanner: unityShowBanner,
          };

          document.querySelector("#unity-loading-bar").style.display = "block";

          var script = document.createElement("script");
          script.src = loaderUrl;
          script.onload = () => {
            createUnityInstance(canvas, config, (progress) => {
              document.querySelector("#unity-progress-bar-full").style.width = 100 * progress + "%";
            }).then((unityInstance) => {
              document.querySelector("#unity-loading-bar").style.display = "none";
              document.querySelector("#unity-fullscreen-button").onclick = () => {
                unityInstance.SetFullscreen(1);
              };
            }).catch((message) => {
              alert(message);
            });
          };

          document.body.appendChild(script);
        } catch (error) {
          console.error('Errore durante il caricamento del file .wasm:', error);
        }
      }

      // Carica il gioco
      loadWasm();
    </script>
  </body>
</html>
